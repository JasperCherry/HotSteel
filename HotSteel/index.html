<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
    border:1px solid #d3d3d3;
    background-color: #f1f1f1;
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
}
</style>
</head>
<body onload="startGame()">

<script>


// player tank vars
var body = new Body("green", 100, 300);
var tower = new Tower(10, 3, 40, "black", 100, 300);
var bullet;
var reloadTime = 0;
var previousX;
var previousY;


// ai tank vars
var aiBody = new Body("gray", 1050, 300);
var aiTower = new Tower(10, 3, 40, "black", 1050, 300);
var aiBullet;
var aiReloadTime = 250;
var aiX="none";
var aiY="none";
var aiDestinationAngle="none";
var aiTargetAngle;
var shotReady=false;
var aiPreviousX;
var aiPreviousY;



var kills = new Array();


//var soundShot = new Audio("shot.mp3");
//var soundShotAi = new Audio("shot.mp3");
//var soundHit = new Audio("hit.mp3");
//var soundHitAi = new Audio("hit.mp3");


function startGame() {
    myGameArea.start();
}

var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = 1000;
        this.canvas.height = 600;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameNo = 0;
        this.interval = setInterval(updateGameArea, 20);
        window.addEventListener('keydown', function (e) {
            e.preventDefault();
            myGameArea.keys = (myGameArea.keys || []);
            myGameArea.keys[e.keyCode] = (e.type == "keydown");
        })
        window.addEventListener('keyup', function (e) {
            myGameArea.keys[e.keyCode] = (e.type == "keydown");
        })
    },
    stop : function() {
        clearInterval(this.interval);
    },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}


function DeadBody(x, y, angle1, angle2) {

    this.widthBody = 30;
    this.heightBody = 50;
    this.heightTower = 40;
    this.widthTower = 3;

    this.color = "black";

    this.angleBody = angle1;
    this.angleTower = angle2;

    this.x = x;
    this.y = y;
    this.update = function() {
        // drawing the body
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angleBody);
        ctx.fillStyle = this.color;
        ctx.fillRect(this.widthBody / -2, this.heightBody / -2, this.widthBody, this.heightBody);
        ctx.restore();

        // drawing the barrel
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angleTower);
        ctx.translate(0, -20);
        ctx.fillStyle = this.color;
        ctx.fillRect(this.widthTower / -2, this.heightTower / -2, this.widthTower, this.heightTower);
        ctx.restore();
        // drawing the tower
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.beginPath();
        ctx.fillStyle = this.color;
        ctx.arc(0, 0, this.radius, 0, 2*Math.PI);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }
}


function Body(color, x, y) {

    this.hp = 100;
    this.width = 30;
    this.height = 50;
    this.speed = 0;
    this.angle = 0;
    this.moveAngle = 0;
    this.x = x;
    this.y = y;
    this.update = function() {
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.fillStyle = color;
        ctx.fillRect(this.width / -2, this.height / -2, this.width, this.height);
        // back part
        ctx.fillStyle = "black";
        ctx.fillRect(this.width / -2, this.height / 2, 10, -4);
        ctx.fillRect(this.width / -2 +20, this.height / 2, 10, -4);
        //machinegun
        ctx.fillStyle = "blac";
        ctx.fillRect(this.width / -2+21, this.height / -2 , 2, 12);
        ctx.restore();
    }
    this.newPos = function() {
        this.angle += this.moveAngle * Math.PI / 180;
        this.x += this.speed * Math.sin(this.angle);
        this.y -= this.speed * Math.cos(this.angle);
    }
}



function Tower(radius, width, height, color, x, y) {

    this.radius = radius;
    this.width = width;
    this.height = height;
    this.speed = 0;
    this.angle = 0;
    this.moveAngle = 0;
    this.x = x;
    this.y = y;
    this.update = function() {

        // drawing the tower
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.arc(0, 0, this.radius, 0, 2*Math.PI);
        ctx.closePath();
        ctx.fill();
        ctx.rotate(this.angle);
        ctx.translate(0, -20);
        ctx.fillStyle = color;
        ctx.fillRect(this.width / -2, this.height / -2, this.width, this.height);
        ctx.restore();

    }
    this.newPos = function() {
        this.angle += this.moveAngle * Math.PI / 180;
    }
}



function Bullet(x, y) {

    this.reloadTime=0;
    this.radius = 2;
    this.speed = 30;
    this.angle = 0;
    this.x = x;
    this.y = y;
    this.px = x;
    this.py = y;

    this.update = function() {
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.px, this.py);
        ctx.rotate(this.angle);
        ctx.beginPath();
        ctx.translate(0, 0);
        ctx.fillStyle = "red";
        ctx.arc(0, 0, this.radius, 0, 2*Math.PI);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }
    this.newPos = function() {
        this.x += this.speed * Math.sin(this.angle);
        this.y -= this.speed * Math.cos(this.angle);
    }
}

///////////////////////////////////// MAIN FUNCTION
function updateGameArea() {

    myGameArea.clear();

    ///////////////////////////////////////////////////////////////////////////// player tank
    body.moveAngle = 0;
    body.speed = 0;
    tower.moveAngle = 0;
    tower.speed = 0;



    // body rotation, turrent static
    if (myGameArea.keys && myGameArea.keys[37]){
      body.moveAngle = -1;
      tower.moveAngle = -1;
    }
    if (myGameArea.keys && myGameArea.keys[39]){
      body.moveAngle = 1;
      tower.moveAngle = 1;
    }
    if (myGameArea.keys && myGameArea.keys[38]){
      body.speed=1;
    }
    if (myGameArea.keys && myGameArea.keys[40]){
      body.speed=-1;
    }

    // map control
    if(body.x>=1000){
      body.x-=2;
    }
    if(body.x<=0){
      body.x+=2;
    }
    if(body.y>=600){
      body.y-=2;
    }
    if(body.y<=0){
      body.y+=2;
    }

    // touching dead tanks by player
    for(var i = 0; i < kills.length; i++) {
          if((Math.abs(kills[i].x-body.x)<30)&&(Math.abs(kills[i].y-body.y)<30)){
            body.x=previousX;
            body.y=previousY;
          }
    }


    // touching enemy tank
    if((Math.abs(aiBody.x-body.x)<30)&&(Math.abs(aiBody.y-body.y)<30)){
      body.x=previousX;
      body.y=previousY;
    }



    // turrent rotation
    if (myGameArea.keys && myGameArea.keys[65]){
      tower.moveAngle = -1;
    }
    if (myGameArea.keys && myGameArea.keys[68]){
      tower.moveAngle = 1;
    }

    // turrent + body rotation
    if (myGameArea.keys && myGameArea.keys[65] && myGameArea.keys[37]){
      tower.moveAngle = -2;
    }
    if (myGameArea.keys && myGameArea.keys[68] && myGameArea.keys[39]){
      tower.moveAngle = 2;
    }
    if (myGameArea.keys && myGameArea.keys[65] && myGameArea.keys[39]){
      tower.moveAngle = 0;
    }
    if (myGameArea.keys && myGameArea.keys[68] && myGameArea.keys[37]){
      tower.moveAngle = 0;
    }



    ///////////////////////////////////////////////////////////////////////////////////////////////// ai tank

    // movement
    aiBody.moveAngle = 0;
    aiBody.speed = 0;
    aiTower.moveAngle = 0;
    aiTower.speed = 0;


    // touching dead tanks by ai tank
     for(var i = 0; i < kills.length; i++) {
          if((Math.abs(kills[i].x-aiBody.x)<30)&&(Math.abs(kills[i].y-aiBody.y)<30)){
            aiBody.x=aiPreviousX;
            aiBody.y=aiPreviousY;
            aiX="none";
            aiY="none";
          }
      }

    // touching player tank
    if((Math.abs(body.x-aiBody.x)<30)&&(Math.abs(body.y-aiBody.y)<30)){
      aiBody.x=aiPreviousX;
      aiBody.y=aiPreviousY;
      aiX="none";
      aiY="none";
    }

    if(Math.abs(aiX-aiBody.x)<15&&Math.abs(aiY-aiBody.y)<15){
      aiX="none";
      aiY="none";
    }

    if(aiX=="none"&&aiY=="none"){
      aiX=Math.round(Math.random()*1000);
      aiY=Math.round(Math.random()*600);
      aiDestinationAngle=Math.atan2(aiBody.y - aiY, aiBody.x - aiX)+(-90 * Math.PI / 180)+2*Math.PI;
      aiBody.speed=1;
    }

    if(Math.abs(aiBody.angle-aiDestinationAngle)<0.03){
      aiBody.speed=1;
      aiBody.angle=aiDestinationAngle;
      aiBody.moveAngle=0;
    }else if(Math.abs(aiBody.angle-aiDestinationAngle)>0.03){
      aiBody.speed=0;
      if(aiBody.angle<aiDestinationAngle){
        aiBody.moveAngle=1;
      }else if(aiBody.angle>aiDestinationAngle){
        aiBody.moveAngle=-1;
      }
    }

// destination target of ai tank to go to
/*
    ctx = myGameArea.context;
    ctx.save();
    ctx.translate(aiX, aiY);
    ctx.fillStyle ="red";
    ctx.fillRect(20 / -2, 20 / -2, 20, 20);
    ctx.restore();
*/
//console.log(Math.abs(aiDestinationAngle));




    //////////////////////////////////////////////////////////////// shooting and hits

    // ai moving the tower
    aiTargetAngle=Math.atan2(aiBody.y - body.y, aiBody.x - body.x)+(-90 * Math.PI / 180);


    if(Math.abs(aiTower.angle-aiTargetAngle)<0.03){
      aiTower.angle=aiTargetAngle;
      shotReady=true;
    }else if(Math.abs(aiTower.angle-aiTargetAngle)>0.03){
      shotReady=false;
      if(aiTower.angle<aiTargetAngle){
        aiTower.moveAngle=1;
      }else if(aiTower.angle>aiTargetAngle){
        aiTower.moveAngle=-1;
      }
    }


    // ai shooting and timing
    if(aiReloadTime>0&&aiBody.x>0&&(aiBody.x<1000&&aiBody.y>0&&aiBody.y<600)){
      aiReloadTime--;
    }
    if (aiReloadTime==0&&shotReady){
      //soundShotAi.play();
      aiBullet = new Bullet(aiBody.x+(40 * Math.sin(aiTower.angle)), aiBody.y-(40 * Math.cos(aiTower.angle)));
      aiBullet.angle = aiTower.angle+( (Math.round(Math.random() * (30)) - 15) * Math.PI / 180);
      aiReloadTime=250;
    }


    // player shooting and timing
    if (myGameArea.keys && myGameArea.keys[83] && reloadTime==0){
      //soundShot.play();
      bullet = new Bullet(body.x+(40 * Math.sin(tower.angle)), body.y-(40 * Math.cos(tower.angle)));
      bullet.angle = tower.angle;
      // not precision shooting
      //bullet.angle = tower.angle+( (Math.round(Math.random() * (30)) - 15) * Math.PI / 180);
      reloadTime=250;
    }
    if(reloadTime>0){
      reloadTime--;
    }

    // player main gun bullet deleting
    if(bullet!=null){
      if(Math.abs(bullet.x-body.x)>2000 || Math.abs(bullet.y-body.y)>2000){
        bullet=null;
      }
    }

    // ai main gun bullet deleting
    if(aiBullet!=null){
      if(Math.abs(aiBullet.x-aiBody.x)>2000 || Math.abs(aiBullet.y-aiBody.y)>2000){
        aiBullet=null;
      }
    }

    // ai tank hit
    if(bullet!=null){
      var xChecks = new Array();
      var yChecks = new Array();
      var xDifference = (bullet.x-bullet.px) / 10;
      var yDifference = (bullet.y-bullet.py) / 10;
      for(var i = 0; i < 10; i++) {
        xChecks.push((i*xDifference)+bullet.px);
        yChecks.push((i*yDifference)+bullet.py);
      }
      for(var i = 0; i < 10; i++) {
        if(Math.abs(xChecks[i]-aiBody.x)<15 && Math.abs(yChecks[i]-aiBody.y)<15){
          aiBody.hp=aiBody.hp-100;
          if(aiBody.hp<=0){
             kills.push(new DeadBody(aiBody.x, aiBody.y, aiBody.angle, aiTower.angle));
             aiBody = new Body("gray", 1050, 300);
             aiTower = new Tower(10, 3, 40, "black", 1050, 300);
           }
        }
      }
      bullet.px=bullet.x;
      bullet.py=bullet.y;
    }

    // player tank hit
    if(aiBullet!=null){
      var xChecks = new Array();
      var yChecks = new Array();
      var xDifference = (aiBullet.x-aiBullet.px) / 10;
      var yDifference = (aiBullet.y-aiBullet.py) / 10;
      for(var i = 0; i < 10; i++) {
        xChecks.push((i*xDifference)+aiBullet.px);
        yChecks.push((i*yDifference)+aiBullet.py);
      }
      for(var i = 0; i < 10; i++) {
        if(Math.abs(xChecks[i]-body.x)<15 && Math.abs(yChecks[i]-body.y)<15){
          body.hp=body.hp-100;
          if(body.hp<=0){
             kills.push(new DeadBody(body.x, body.y, body.angle, tower.angle));
             body = new Body("green", 100, 300);
             tower = new Tower(10, 3, 40, "black", 100, 300);
           }
        }
      }
      aiBullet.px=aiBullet.x;
      aiBullet.py=aiBullet.y;
    }


/*
   // player tank hit
   if(aiBullet!=null && Math.abs(aiBullet.x-body.x)<15 && Math.abs(aiBullet.y-body.y)<15) {
     //soundHit.play();
     body.hp=body.hp-100;
     if(body.hp<=0){
       kills.push(new DeadBody(body.x, body.y, body.angle, tower.angle));
       body = new Body("green", 100, 300);
       tower = new Tower(10, 3, 40, "black", 100, 300);
     }
     aiBullet=null;
   }
*/



   // dead tank hit by player
   for(var i = 0; i < kills.length; i++) {
     if(bullet!=null && Math.abs(kills[i].x-bullet.x)<15 && Math.abs(kills[i].y-bullet.y)<15) {
       //soundHit.play();
       bullet=null;
     }
   }

   // dead tank hit by ai tank
   for(var i = 0; i < kills.length; i++) {
     if(aiBullet!=null && Math.abs(kills[i].x-aiBullet.x)<15 && Math.abs(kills[i].y-aiBullet.y)<15) {
       //soundHit.play();
       aiBullet=null;
     }
   }



   ///////////////////////////////////////////////////////////////////////// drawing

   // previous positions of tanks
   previousX=body.x;
   previousY=body.y;
   aiPreviousX=aiBody.x;
   aiPreviousY=aiBody.y;

   // drawing killed tanks
   for(var i = 0; i < kills.length; i++) {
     kills[i].update();
   }


   // drawing ai
   aiBody.newPos();
   aiTower.newPos();
   if(aiBullet!=null){
     aiBullet.newPos();
   }

   aiTower.x=aiBody.x;
   aiTower.y=aiBody.y;

   aiBody.update();
   aiTower.update();
   if(aiBullet!=null){
     aiBullet.update();
   }


   // drawing player
   body.newPos();
   tower.newPos();
   if(bullet!=null){
     bullet.newPos();
   }

   tower.x=body.x;
   tower.y=body.y;

   body.update();
   tower.update();
   if(bullet!=null){
     bullet.update();
   }


}
</script>



</body>
</html>
