<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
    border:1px solid #d3d3d3;
    background-color: #f1f1f1;
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
}
</style>
</head>
<body onload="startGame()">

<script src="objects.js"></script>

<script>


// player tank vars
var body = new Body("green", 100, 300);
var tower = new Tower(10, 3, 40, "black", 100, 300);
var reloadTime = 250;
var reloadTimeM = 0;
var reloadTimeMine = 50;
var previousX;
var previousY;
var bullet;
var mgBullets = new Array();


// ai tank vars
var aiBody = new Body("gray", 1050, 300);
var aiTower = new Tower(10, 3, 40, "black", 1050, 300);
var aiBullet;
var aiReloadTime = 250;
var aiReloadTimeM = 0;
var aiX="none";
var aiY="none";
var aiDestinationAngle="none";
var aiTargetAngle;
var shotReady=false;
var mgShotReady=false;
var aiPreviousX;
var aiPreviousY;
var aiMgBullets = new Array();


// map vars
var kills = new Array();
var mines = new Array();
// area that tanks play at
fieldMapX=1000;
fieldMapY=600;


//var soundShot = new Audio("shot.mp3");
//var soundShotAi = new Audio("shot.mp3");
//var soundHit = new Audio("hit.mp3");
//var soundHitAi = new Audio("hit.mp3");


function startGame() {
    myGameArea.start();
}

var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = fieldMapX;
        this.canvas.height = fieldMapY+50;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameNo = 0;
        this.interval = setInterval(updateGameArea, 20);
        window.addEventListener('keydown', function (e) {
            e.preventDefault();
            myGameArea.keys = (myGameArea.keys || []);
            myGameArea.keys[e.keyCode] = (e.type == "keydown");
        })
        window.addEventListener('keyup', function (e) {
            myGameArea.keys[e.keyCode] = (e.type == "keydown");
        })
    },
    stop : function() {
        clearInterval(this.interval);
    },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}




///////////////////////////////////// MAIN FUNCTION
function updateGameArea() {


///////////////////////////////////////////////////////////////////////////// player tank
    body.moveAngle = 0;
    body.speed = 0;
    tower.moveAngle = 0;
    tower.speed = 0;



    // body rotation, turrent static
    if (myGameArea.keys && myGameArea.keys[37]){
      body.moveAngle = -1;
      tower.moveAngle = -1;
    }
    if (myGameArea.keys && myGameArea.keys[39]){
      body.moveAngle = 1;
      tower.moveAngle = 1;
    }
    if (myGameArea.keys && myGameArea.keys[38]){
      body.speed=1;
    }
    if (myGameArea.keys && myGameArea.keys[40]){
      body.speed=-1;
    }

    // map control
    if(body.x>=fieldMapX){
      body.x-=2;
    }
    if(body.x<=0){
      body.x+=2;
    }
    if(body.y>=fieldMapY){
      body.y-=2;
    }
    if(body.y<=0){
      body.y+=2;
    }

    // touching dead tanks by player
    for(var i = 0; i < kills.length; i++) {
          if((Math.abs(kills[i].x-body.x)<30)&&(Math.abs(kills[i].y-body.y)<30)){
            body.x=previousX;
            body.y=previousY;
          }
    }


    // touching enemy tank
    if((Math.abs(aiBody.x-body.x)<30)&&(Math.abs(aiBody.y-body.y)<30)){
      body.x=previousX;
      body.y=previousY;
    }



    // turrent rotation
    if (myGameArea.keys && myGameArea.keys[65]){
      tower.moveAngle = -1;
    }
    if (myGameArea.keys && myGameArea.keys[68]){
      tower.moveAngle = 1;
    }

    // turrent + body rotation
    if (myGameArea.keys && myGameArea.keys[65] && myGameArea.keys[37]){
      tower.moveAngle = -2;
    }
    if (myGameArea.keys && myGameArea.keys[68] && myGameArea.keys[39]){
      tower.moveAngle = 2;
    }
    if (myGameArea.keys && myGameArea.keys[65] && myGameArea.keys[39]){
      tower.moveAngle = 0;
    }
    if (myGameArea.keys && myGameArea.keys[68] && myGameArea.keys[37]){
      tower.moveAngle = 0;
    }

    // player shooting and timing

    // setting up mines
    if(reloadTimeMine>0){
      reloadTimeMine--;
    }
    if (myGameArea.keys && myGameArea.keys[71] && body.numMines>0 && reloadTimeMine==0){
      mines.push(new Mine(
      body.x-(35 * Math.sin(body.angle)),
      body.y+(35 * Math.cos(body.angle))
      ));
      body.numMines--;
      reloadTimeMine=50;
    }

    // mines
    // detection if player tank is on the mine and trigering it
    for(var i = 0; i < mines.length; i++) {
      if(Math.abs(mines[i].x-body.x)<15 && Math.abs(mines[i].y-body.y)<15){
        body.hp=body.hp-100;
        mines.splice(i,1);
      }
    }

    // main gun
    if (myGameArea.keys && myGameArea.keys[83] && reloadTime==0 && body.numBullet>0){
      //soundShot.play();
      body.numBullet--;
      bullet = new Bullet(
      body.x+(40 * Math.sin(tower.angle)),
      body.y-(40 * Math.cos(tower.angle)),
      tower.angle+( (Math.round(Math.random() * (30)) - 15) * Math.PI / 180));
      // not precision shooting
      //bullet.angle = tower.angle+( (Math.round(Math.random() * (30)) - 15) * Math.PI / 180);
      reloadTime=250;
    }
    if(reloadTime>0){
      reloadTime--;
    }

    // player main gun bullet deleting
    if(bullet!=null){
      if(Math.abs(bullet.x-body.x)>2000 || Math.abs(bullet.y-body.y)>2000){
        bullet=null;
      }
    }

    // machinegun
    if (myGameArea.keys && myGameArea.keys[87] && reloadTimeM==0 && body.numMgBullets>0){
      body.numMgBullets--;
      mgBullets.push(new MgBullet(
      body.x+(25 * Math.sin(body.angle))+ 7 * (Math.sin(body.angle+90 * Math.PI / 180)),
      body.y-(25 * Math.cos(body.angle))- 7 * (Math.cos(body.angle+90 * Math.PI / 180)),
      body.angle + ((Math.round(Math.random() * (20)) - 10) * Math.PI / 180)));
      reloadTimeM=8;
    }
    if(reloadTimeM>0){
      reloadTimeM--;
    }

    // player machinegun bullet deleting
    for(var i = 0; i < mgBullets.length; i++) {
      if(Math.abs(mgBullets[i].x-body.x)>2000 || Math.abs(mgBullets[i].y-body.y)>2000){
        mgBullets.splice(i,i+1);
      }
    }


    // gun
    // detection if player hits  ai tank
    if(bullet!=null){
      var xChecks = new Array();
      var yChecks = new Array();
      var xDifference = (bullet.x-bullet.px) / 10;
      var yDifference = (bullet.y-bullet.py) / 10;
      for(var i = 0; i < 10; i++) {
        xChecks.push((i*xDifference)+bullet.px);
        yChecks.push((i*yDifference)+bullet.py);
      }
      for(var i = 0; i < 10; i++) {
        if(Math.abs(xChecks[i]-aiBody.x)<15 && Math.abs(yChecks[i]-aiBody.y)<15){
          aiBody.hp=aiBody.hp-50;
          bullet=null;
          break;
        }
      }
      if(bullet!=null){
        bullet.px=bullet.x;
        bullet.py=bullet.y;
      }
    }

   // dead tank hit by player
   for(var i = 0; i < kills.length; i++) {
     if(bullet!=null && Math.abs(kills[i].x-bullet.x)<15 && Math.abs(kills[i].y-bullet.y)<15) {
       //soundHit.play();
       bullet=null;
     }
   }

   // machinegun
   // detection if player hits  ai tank
   for(var i = 0; i < mgBullets.length; i++) {
     if(Math.abs(mgBullets[i].x-aiBody.x)<15 && Math.abs(mgBullets[i].y-aiBody.y)<15){
       mgBullets.splice(i,1);
       aiBody.hp=aiBody.hp-5;
     }
   }
   // detection if player hits dead tank
   for(var j = 0; j < kills.length; j++) {
    for(var i = 0; i < mgBullets.length; i++) {
     if(Math.abs(mgBullets[i].x-kills[j].x)<15 && Math.abs(mgBullets[i].y-kills[j].y)<15){
        mgBullets.splice(i,1);
     }
    }
   }

   // ai kill detection
   if(aiBody.hp<=0){
      kills.push(new DeadBody(aiBody.x, aiBody.y, aiBody.angle, aiTower.angle));
      aiBody = new Body("gray", 1050, 300);
      aiTower = new Tower(10, 3, 40, "black", 1050, 300);
      aiX="none";
      aiY="none";
      aiReloadTime=250;
    }

///////////////////////////////////////////////////////////////////////////////////////////////// ai tank

    // movement
    aiBody.moveAngle = 0;
    aiBody.speed = 0;
    aiTower.moveAngle = 0;
    aiTower.speed = 0;

    // touching dead tanks by ai tank
     for(var i = 0; i < kills.length; i++) {
          if((Math.abs(kills[i].x-aiBody.x)<30)&&(Math.abs(kills[i].y-aiBody.y)<30)){
            aiBody.x=aiPreviousX;
            aiBody.y=aiPreviousY;
            aiX="none";
            aiY="none";
          }
      }

    // touching player tank
    if((Math.abs(body.x-aiBody.x)<30)&&(Math.abs(body.y-aiBody.y)<30)){
      aiBody.x=aiPreviousX;
      aiBody.y=aiPreviousY;
      aiX="none";
      aiY="none";
    }

    if(Math.abs(aiX-aiBody.x)<15&&Math.abs(aiY-aiBody.y)<15){
      aiX="none";
      aiY="none";
    }

    if(aiX=="none"&&aiY=="none"){
      aiX=Math.round(Math.random()*fieldMapX);
      aiY=Math.round(Math.random()*fieldMapY);
      aiDestinationAngle=Math.atan2(aiBody.y - aiY, aiBody.x - aiX)+(-90 * Math.PI / 180)+2*Math.PI;
      aiBody.speed=1;
    }

    if(Math.abs(aiBody.angle-aiDestinationAngle)<0.03){
      aiBody.speed=1;
      aiBody.angle=aiDestinationAngle;
      aiBody.moveAngle=0;
    }else if(Math.abs(aiBody.angle-aiDestinationAngle)>0.03){
      aiBody.speed=0;
      if(aiBody.angle<aiDestinationAngle){
        aiBody.moveAngle=1;
      }else if(aiBody.angle>aiDestinationAngle){
        aiBody.moveAngle=-1;
      }
    }

// destination target of ai tank to go to
/*
    ctx = myGameArea.context;
    ctx.save();
    ctx.translate(aiX, aiY);
    ctx.fillStyle ="red";
    ctx.fillRect(20 / -2, 20 / -2, 20, 20);
    ctx.restore();
*/

    // ai moving the tower
    aiTargetAngle=Math.atan2(aiBody.y - body.y, aiBody.x - body.x)+(-90 * Math.PI / 180);

    if(Math.abs(aiTower.angle-aiTargetAngle)<0.03){
      aiTower.angle=aiTargetAngle;
      shotReady=true;
    }else if(Math.abs(aiTower.angle-aiTargetAngle)>0.03){
      shotReady=false;
      if(aiTower.angle<aiTargetAngle){
        aiTower.moveAngle=1;
      }else if(aiTower.angle>aiTargetAngle){
        aiTower.moveAngle=-1;
      }
    }

    // ai shooting and timing

    // mines
    // detection if ai tank is on the mine and trigering it
    for(var i = 0; i < mines.length; i++) {
      if(Math.abs(mines[i].x-aiBody.x)<15 && Math.abs(mines[i].y-aiBody.y)<15){
        aiBody.hp=aiBody.hp-100;
        mines.splice(i,1);
      }
    }

    // main gun
    if(aiReloadTime>0&&aiBody.x>0&&(aiBody.x<1000&&aiBody.y>0&&aiBody.y<600)){
      aiReloadTime--;
    }
    if (aiReloadTime==0&&shotReady){
      //soundShotAi.play();
      aiBullet = new Bullet(aiBody.x+(40 * Math.sin(aiTower.angle)), aiBody.y-(40 * Math.cos(aiTower.angle)),
      aiTower.angle+( (Math.round(Math.random() * (20)) - 10) * Math.PI / 180));
      aiReloadTime=250;
    }

    // ai main gun bullet deleting
    if(aiBullet!=null){
      if(Math.abs(aiBullet.x-aiBody.x)>2000 || Math.abs(aiBullet.y-aiBody.y)>2000){
        aiBullet=null;
      }
    }

    // ai tank machinegun
    // targeting player tank for mg
    if( (Math.abs(body.x-aiBody.x)<400 && Math.abs(body.y-aiBody.y)<400)
    && ( (Math.round((aiTargetAngle+2*Math.PI) * 3) / 3) == (Math.round(aiBody.angle * 3) / 3) )
    ){
      mgShotReady=true;
    }else{
      mgShotReady=false;
    }
    // firing mg
    if (aiReloadTimeM==0 && aiBody.numMgBullets>0 && mgShotReady){
      aiBody.numMgBullets--;
      aiMgBullets.push(new MgBullet(
      aiBody.x+(25 * Math.sin(aiBody.angle))+ 7 * (Math.sin(aiBody.angle+90 * Math.PI / 180)),
      aiBody.y-(25 * Math.cos(aiBody.angle))- 7 * (Math.cos(aiBody.angle+90 * Math.PI / 180)),
      aiBody.angle + ((Math.round(Math.random() * (20)) - 10) * Math.PI / 180)));
      aiReloadTimeM=8;
    }
    if(aiReloadTimeM>0){
      aiReloadTimeM--;
    }

    // ai machinegun bullet deleting
    for(var i = 0; i < aiMgBullets.length; i++) {
      if(Math.abs(aiMgBullets[i].x-aiBody.x)>2000 || Math.abs(aiMgBullets[i].y-aiBody.y)>2000){
        aiMgBullets.splice(i,i+1);
      }
    }

    // main gun
    // detection if ai hits player tank
    if(aiBullet!=null){
      var xChecks = new Array();
      var yChecks = new Array();
      var xDifference = (aiBullet.x-aiBullet.px) / 10;
      var yDifference = (aiBullet.y-aiBullet.py) / 10;
      for(var i = 0; i < 10; i++) {
        xChecks.push((i*xDifference)+aiBullet.px);
        yChecks.push((i*yDifference)+aiBullet.py);
      }
      for(var i = 0; i < 10; i++) {
        if(Math.abs(xChecks[i]-body.x)<15 && Math.abs(yChecks[i]-body.y)<15){
          body.hp=body.hp-50;
          aiBullet=null;
          break;
        }
      }
      if(aiBullet!=null){
        aiBullet.px=aiBullet.x;
        aiBullet.py=aiBullet.y;
      }
    }
   // dead tank hit by ai tank
   for(var i = 0; i < kills.length; i++) {
     if(aiBullet!=null && Math.abs(kills[i].x-aiBullet.x)<15 && Math.abs(kills[i].y-aiBullet.y)<15) {
       //soundHit.play();
       aiBullet=null;
     }
   }

   // machinegun
   // detection if ai hits  dead tank
   for(var i = 0; i < aiMgBullets.length; i++) {
     if(Math.abs(aiMgBullets[i].x-body.x)<15 && Math.abs(aiMgBullets[i].y-body.y)<15){
       aiMgBullets.splice(i,1);
       body.hp=body.hp-5;
     }
   }
   // detection if ai hits dead tank
   for(var j = 0; j < kills.length; j++) {
    for(var i = 0; i < aiMgBullets.length; i++) {
     if(Math.abs(aiMgBullets[i].x-kills[j].x)<15 && Math.abs(aiMgBullets[i].y-kills[j].y)<15){
        aiMgBullets.splice(i,1);
     }
    }
   }

   // player kill detection
   if(body.hp<=0){
      kills.push(new DeadBody(body.x, body.y, body.angle, tower.angle));
      body = new Body("green", 100, 300);
      tower = new Tower(10, 3, 40, "black", 100, 300);
      reloadTime = 250;
    }


   ///////////////////////////////////////////////////////////////////////// drawing

   myGameArea.clear();

   // previous positions of tanks
   previousX=body.x;
   previousY=body.y;
   aiPreviousX=aiBody.x;
   aiPreviousY=aiBody.y;

   // mines
   for(var i = 0; i < mines.length; i++) {
     mines[i].update();
   }

   // drawing killed tanks
   for(var i = 0; i < kills.length; i++) {
     kills[i].update();
   }


   ///////////////////////////////////////////// drawing ai
   aiBody.newPos();
   aiTower.newPos();
   if(aiBullet!=null){
     aiBullet.newPos();
   }
   for(var i = 0; i < aiMgBullets.length; i++) {
     aiMgBullets[i].newPos();
   }

   aiTower.x=aiBody.x;
   aiTower.y=aiBody.y;

   aiBody.update();
   aiTower.update();
   if(aiBullet!=null){
     aiBullet.update();
   }
   for(var i = 0; i < aiMgBullets.length; i++) {
     aiMgBullets[i].update();
   }


   ///////////////////////////////// drawing player
   // new positions
   body.newPos();
   tower.newPos();
   if(bullet!=null){
     bullet.newPos();
   }
   for(var i = 0; i < mgBullets.length; i++) {
     mgBullets[i].newPos();
   }

   tower.x=body.x;
   tower.y=body.y;

   // drawing
   body.update();
   tower.update();
   // drawing main gun bullets
   if(bullet!=null){
     bullet.update();
   }
   // drawing machinegun bullets
   for(var i = 0; i < mgBullets.length; i++) {
     mgBullets[i].update();
   }


   // drawing informations about current game
   ctx = myGameArea.context;

   ctx.fillStyle ="black";
   ctx.fillRect( 0, 600, 1000, 50);
   ctx.font = "20px Arial";
   ctx.fillStyle = "white";

   ctx.fillText("Player HP",10,620);
   ctx.fillText(body.hp,10,645);

   ctx.fillText("Cannon ammo",110,620);
   ctx.fillText(body.numBullet,110,645);
   if(reloadTime==0){
     ctx.fillStyle = "red";
     ctx.fillText("ready",160,645);
   }else{
     ctx.fillStyle = "white";
     ctx.fillText("loading",160,645);
   }

   ctx.fillStyle = "white";
   ctx.fillText("MG ammo",260,620);
   ctx.fillText(body.numMgBullets,260,645);

   ctx.fillText("Mines",370,620);
   ctx.fillText(body.numMines,370,645);

   ctx.fillText("Enemy HP",895,620);
   ctx.fillText(aiBody.hp,895,645);


}
</script>



</body>
</html>
