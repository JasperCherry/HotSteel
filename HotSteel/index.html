<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
    border:1px solid #d3d3d3;
    background-color: #f1f1f1;
    padding-left: 0;
    padding-right: 0;
    margin-left: auto;
    margin-right: auto;
    display: block;
}
</style>
</head>
<body onload="startGame()">

<img src="tanks/rusa.png" id="rusa" style="display: none;">
<img src="tanks/rusb.png" id="rusb" style="display: none;">
<img src="tanks/gera.png" id="gera" style="display: none;">
<img src="tanks/gerb.png" id="gerb" style="display: none;">


<img src="wrecks/rusaw.png" id="rusaw" style="display: none;">
<img src="wrecks/rusbw.png" id="rusbw" style="display: none;">
<img src="wrecks/geraw.png" id="geraw" style="display: none;">
<img src="wrecks/gerbw.png" id="gerbw" style="display: none;">


<img src="fire/loop/l0.png" id="l0" style="display: none;">
<img src="fire/loop/l1.png" id="l1" style="display: none;">
<img src="fire/loop/l2.png" id="l2" style="display: none;">
<img src="fire/loop/l3.png" id="l3" style="display: none;">
<img src="fire/loop/l4.png" id="l4" style="display: none;">
<img src="fire/loop/l5.png" id="l5" style="display: none;">
<img src="fire/loop/l6.png" id="l6" style="display: none;">
<img src="fire/loop/l7.png" id="l7" style="display: none;">
<img src="fire/loop/l8.png" id="l8" style="display: none;">
<img src="fire/loop/l9.png" id="l9" style="display: none;">


<img src="fire/start/s0.png" id="s0" style="display: none;">
<img src="fire/start/s1.png" id="s1" style="display: none;">
<img src="fire/start/s2.png" id="s2" style="display: none;">
<img src="fire/start/s3.png" id="s3" style="display: none;">
<img src="fire/start/s4.png" id="s4" style="display: none;">
<img src="fire/start/s5.png" id="s5" style="display: none;">
<img src="fire/start/s6.png" id="s6" style="display: none;">
<img src="fire/start/s7.png" id="s7" style="display: none;">

<img src="fire/end/e0.png" id="e0" style="display: none;">
<img src="fire/end/e1.png" id="e1" style="display: none;">
<img src="fire/end/e2.png" id="e2" style="display: none;">
<img src="fire/end/e3.png" id="e3" style="display: none;">
<img src="fire/end/e4.png" id="e4" style="display: none;">
<img src="fire/end/e5.png" id="e5" style="display: none;">


<img src="maps/map1.jpg" id="map1" style="display: none;">


<script src="objects.js"></script>

<script>

function startGame() {
    myGameArea.start();
}

var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = fieldMapX;
        this.canvas.height = fieldMapY+50;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameNo = 0;
        this.interval = setInterval(updateGameArea, 20);
        window.addEventListener('keydown', function (e) {
            e.preventDefault();
            myGameArea.keys = (myGameArea.keys || []);
            myGameArea.keys[e.keyCode] = (e.type == "keydown");
        })
        window.addEventListener('keyup', function (e) {
            myGameArea.keys[e.keyCode] = (e.type == "keydown");
        })
    },
    stop : function() {
        clearInterval(this.interval);
    },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}




//////////////////////////////////////////////////////////////////////////////////
// player tank vars
var pTank = new PTank(100,300,rusa,rusb);
var bulletP;
var mgBulletsP = new Array();

var aiTank = new AiTank(900,300,gera,gerb);
var bulletAi;
var mgBulletsAi = new Array();


// map variables
var kills = new Array();
var killsFire = new Array();
var mines = new Array();
// area that tanks play at
var fieldMapX=1000;
var fieldMapY=600;









///////////////////////////////////// MAIN FUNCTION
function updateGameArea() {


// Player tank ////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////// player tank


    // touching enemy tank
    if((Math.abs(aiTank.x-pTank.x)<30)&&(Math.abs(aiTank.y-pTank.y)<30)){
      pTank.x=pTank.previousX;
      pTank.y=pTank.previousY;
    }

    // gun
    // detection if player hits  ai tank
    if(bulletP!=null){
      if(Math.abs(bulletP.x-aiTank.x)<15 && Math.abs(bulletP.y-aiTank.y)<15){
          aiTank.hp=aiTank.hp-50;
          bulletP=null;
      }
    }

    // dead tank hit by player
    for(var i = 0; i < kills.length; i++) {
      if(bulletP!=null && Math.abs(kills[i].x-bulletP.x)<15 && Math.abs(kills[i].y-bulletP.y)<15) {
        bulletP=null;
      }
    }

    // machinegun
    // detection if player hits  ai tank
    for(var i = 0; i < mgBulletsP.length; i++) {
      if(Math.abs(mgBulletsP[i].x-aiTank.x)<15 && Math.abs(mgBulletsP[i].y-aiTank.y)<15){
        mgBulletsP.splice(i,1);
        aiTank.hp=aiTank.hp-5;
      }
    }
    // detection if player hits dead tank
    for(var j = 0; j < kills.length; j++) {
     for(var i = 0; i < mgBulletsP.length; i++) {
      if(Math.abs(mgBulletsP[i].x-kills[j].x)<15 && Math.abs(mgBulletsP[i].y-kills[j].y)<15){
         mgBulletsP.splice(i,1);
      }
     }
    }

    // ai kill detection
    if(aiTank.hp<=0){
       kills.push(new DeadBody(aiTank.x, aiTank.y, aiTank.angleB, aiTank.angleT, geraw, gerbw));
       killsFire.push(new DeadBodyFire(aiTank.x, aiTank.y));
       aiTank = new AiTank(900,300,gera,gerb);
     }



///////////////////////////////////////////////////////////////////////////// ai tank

    // touching player tank
    if((Math.abs(pTank.x-aiTank.x)<30)&&(Math.abs(pTank.y-aiTank.y)<30)){
      aiTank.x=aiTank.previousX;
      aiTank.y=aiTank.previousY;
      aiTank.aiX="none";
      aiTank.aiY="none";
    }

    // ai shooting and timing

    // ai moving the tower
    aiTank.aiTargetAngle=Math.atan2(aiTank.y - pTank.y, aiTank.x - pTank.x)+(-90 * Math.PI / 180);

    // detecting if player tank is aimed by cannon
    if(Math.abs(aiTank.angleT-aiTank.aiTargetAngle)<0.03){
      aiTank.angleT=aiTank.aiTargetAngle;
      aiTank.shotReady=true;
    }else if(Math.abs(aiTank.angleT-aiTank.aiTargetAngle)>0.03){
      aiTank.shotReady=false;
      if(aiTank.angleT<aiTank.aiTargetAngle){
        aiTank.moveAngleT=1;
      }else if(aiTank.angleT>aiTank.aiTargetAngle){
        aiTank.moveAngleT=-1;
      }
    }

    // targeting player tank for mg
    if( (Math.abs(pTank.x-aiTank.x)<400 && Math.abs(pTank.y-aiTank.y)<400)
    && ( (Math.round((aiTank.aiTargetAngle+2*Math.PI) * 3) / 3) == (Math.round(aiTank.angleB * 3) / 3) )
    ){
      aiTank.mgShotReady=true;
    }else{
      aiTank.mgShotReady=false;
    }


    // gun
    // detection if ai hits player tank
    if(bulletAi!=null){
      if(Math.abs(bulletAi.x-pTank.x)<15 && Math.abs(bulletAi.y-pTank.y)<15){
          pTank.hp=pTank.hp-50;
          bulletAi=null;
      }
    }

    // dead tank hit by ai tank
    for(var i = 0; i < kills.length; i++) {
      if(bulletAi!=null && Math.abs(kills[i].x-bulletAi.x)<15 && Math.abs(kills[i].y-bulletAi.y)<15) {
        bulletAi=null;
      }
    }

    // machinegun
    // detection if ai hits player
    for(var i = 0; i < mgBulletsAi.length; i++) {
      if(Math.abs(mgBulletsAi[i].x-pTank.x)<15 && Math.abs(mgBulletsAi[i].y-pTank.y)<15){
        mgBulletsAi.splice(i,1);
        pTank.hp=pTank.hp-5;
      }
    }
    // detection if ai hits dead tank
    for(var j = 0; j < kills.length; j++) {
     for(var i = 0; i < mgBulletsAi.length; i++) {
      if(Math.abs(mgBulletsAi[i].x-kills[j].x)<15 && Math.abs(mgBulletsAi[i].y-kills[j].y)<15){
         mgBulletsAi.splice(i,1);
      }
     }
    }

    // player kill detection
    if(pTank.hp<=0){
       kills.push(new DeadBody(pTank.x, pTank.y, pTank.angleB, pTank.angleB, rusaw, rusbw));
       killsFire.push(new DeadBodyFire(pTank.x, pTank.y));
       pTank = new PTank(100,300,rusa,rusb);
     }


///////////////////////////////////// drawing objects

// drawing the map
var ctx = myGameArea.context;
var map1=document.getElementById("map1");
ctx.drawImage(map1, 0, 0);

// mines
for(var i = 0; i < mines.length; i++) {
  mines[i].update();
}

// drawing killed tanks
for(var i = 0; i < kills.length; i++) {
  kills[i].update();
}


/////////////////////////////////////////////////////////////////////////
///////////////////////////////// drawing ai
// new positions
aiTank.newPos();
if(bulletAi!=null){
  bulletAi.newPos();
}
for(var i = 0; i < mgBulletsAi.length; i++) {
  mgBulletsAi[i].newPos();
}
// drawing
aiTank.update();
if(bulletAi!=null){
  bulletAi.update();
}
for(var i = 0; i < mgBulletsAi.length; i++) {
  mgBulletsAi[i].update();
}


///////////////////////////////// drawing player
// new positions
pTank.newPos();
if(bulletP!=null){
  bulletP.newPos();
}
for(var i = 0; i < mgBulletsP.length; i++) {
  mgBulletsP[i].newPos();
}
// drawing
pTank.update();
if(bulletP!=null){
  bulletP.update();
}
for(var i = 0; i < mgBulletsP.length; i++) {
  mgBulletsP[i].update();
}
//////////////////////////////////////////////////////////////////////////


////////////////////////////////////// drawing smoke and fire effects

// fire at dead tanks
for(var i = 0; i < killsFire.length; i++) {
  killsFire[i].update();
}

// drawing informations about current game

ctx.fillStyle ="black";
ctx.fillRect( 0, 600, 1000, 50);
ctx.font = "20px Arial";
ctx.fillStyle = "white";

ctx.fillText("Player HP",10,620);
ctx.fillText(pTank.hp,10,645);

ctx.fillText("Cannon ammo",110,620);
ctx.fillText(pTank.numBullet,110,645);
if(pTank.reloadTime==0){
  ctx.fillStyle = "red";
  ctx.fillText("ready",160,645);
}else{
  ctx.fillStyle = "white";
  ctx.fillText("loading",160,645);
}

ctx.fillStyle = "white";
ctx.fillText("MG ammo",260,620);
ctx.fillText(pTank.numMgBullets,260,645);

ctx.fillText("Mines",370,620);
ctx.fillText(pTank.numMines,370,645);

ctx.fillText("Enemy HP",895,620);
ctx.fillText(aiTank.hp,895,645);

}// end of a game update function
</script>



</body>
</html>
