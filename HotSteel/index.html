<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
    border:1px solid #d3d3d3;
    background-color: #f1f1f1;
}
</style>
</head>
<body onload="startGame()">

<script>



var body = new Body(30, 50, "green", 100, 300);
var tower = new Tower(10, 3, 40, "black", 100, 300);
var bullet;
var reloadTime = 0;
var previousX;
var previousY;


var aiBody = new Body(30, 50, "gray", 500, 300);
var aiTower = new Tower(10, 3, 40, "black", 500, 300);
var aiBullet;
var aiReloadTime = 250;
var aiX="none";
var aiY="none";
var aiDestinationAngle="none";
var aiTargetAngle;
var shotReady=false;
var aiPreviousX;
var aiPreviousY;

var kills = new Array();
var marks = new Array();
var aiMarks = new Array();

//var soundShot = new Audio("shot.mp3");
//var soundShotAi = new Audio("shot.mp3");
//var soundHit = new Audio("hit.mp3");
//var soundHitAi = new Audio("hit.mp3");


function startGame() {
    myGameArea.start();
}

var myGameArea = {
    canvas : document.createElement("canvas"),
    start : function() {
        this.canvas.width = 800;
        this.canvas.height = 600;
        this.context = this.canvas.getContext("2d");
        document.body.insertBefore(this.canvas, document.body.childNodes[0]);
        this.frameNo = 0;
        this.interval = setInterval(updateGameArea, 20);
        window.addEventListener('keydown', function (e) {
            e.preventDefault();
            myGameArea.keys = (myGameArea.keys || []);
            myGameArea.keys[e.keyCode] = (e.type == "keydown");
        })
        window.addEventListener('keyup', function (e) {
            myGameArea.keys[e.keyCode] = (e.type == "keydown");
        })
    },
    stop : function() {
        clearInterval(this.interval);
    },
    clear : function() {
        this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
    }
}

function movingMark(x, y) {

    this.radius = 2;


    this.x = x;
    this.y = y;
    this.bulletAngle=Math.atan2(aiBody.x - this.x, aiBody.y - this.y)+(-90 * Math.PI / 180);




    this.update = function() {



      ctx = myGameArea.context;
      ctx.save();



      this.bulletAngle=this.bulletAngle + aiBody.moveAngle*Math.PI / 180;

      ctx.translate(aiBody.x, aiBody.y);
      ctx.rotate(this.bulletAngle);

      this.x += aiBody.speed * Math.sin(aiBody.angle);
      this.y -= aiBody.speed * Math.cos(aiBody.angle);
      ctx.translate(aiBody.x-this.x, aiBody.y-this.y);

      ctx.beginPath();
      ctx.fillStyle = "red";
      ctx.arc(0, 0, this.radius, 0, 2*Math.PI);
      ctx.closePath();

      ctx.fill();
      ctx.restore();
      }
}

function Mark(x, y) {

    this.radius = 2;
    this.x = x;
    this.y = y;

    this.update = function() {
      ctx = myGameArea.context;
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.beginPath();
      ctx.fillStyle = "red";
      ctx.arc(0, 0, this.radius, 0, 2*Math.PI);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
      }
}


function DeadBody(x, y, angle1, angle2) {

    this.widthBody = 30;
    this.heightBody = 50;
    this.heightTower = 40;
    this.widthTower = 3;

    this.color = "black";

    this.angleBody = angle1;
    this.angleTower = angle2;

    this.x = x;
    this.y = y;
    this.update = function() {
        // drawing the body
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angleBody);
        ctx.fillStyle = this.color;
        ctx.fillRect(this.widthBody / -2, this.heightBody / -2, this.widthBody, this.heightBody);
        ctx.restore();
        // drawing the barrel
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angleTower);
        ctx.translate(0, -20);
        ctx.fillStyle = this.color;
        ctx.fillRect(this.widthTower / -2, this.heightTower / -2, this.widthTower, this.heightTower);
        ctx.restore();
        // drawing the tower
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.beginPath();
        ctx.fillStyle = this.color;
        ctx.arc(0, 0, this.radius, 0, 2*Math.PI);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }
}


function Body(width, height, color, x, y) {

    this.hp = 100;
    this.width = width;
    this.height = height;
    this.speed = 0;
    this.angle = 0;
    this.moveAngle = 0;
    this.x = x;
    this.y = y;
    this.update = function() {
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.fillStyle = color;
        ctx.fillRect(this.width / -2, this.height / -2, this.width, this.height);
        ctx.restore();
    }
    this.newPos = function() {
        this.angle += this.moveAngle * Math.PI / 180;
        this.x += this.speed * Math.sin(this.angle);
        this.y -= this.speed * Math.cos(this.angle);
    }
}



function Tower(radius, width, height, color, x, y) {

    this.radius = radius;
    this.width = width;
    this.height = height;
    this.speed = 0;
    this.angle = 0;
    this.moveAngle = 0;
    this.x = x;
    this.y = y;
    this.update = function() {

        // drawing the tower
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.arc(0, 0, this.radius, 0, 2*Math.PI);
        ctx.closePath();
        ctx.fill();
        ctx.restore();

        // drawing the barrel
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.translate(0, -20);
        ctx.fillStyle = color;
        ctx.fillRect(this.width / -2, this.height / -2, this.width, this.height);
        ctx.restore();

    }
    this.newPos = function() {
        this.angle += this.moveAngle * Math.PI / 180;
    }
}

/*
function Tower(radius, color, x, y) {

    this.radius = radius;
    this.speed = 0;
    this.x = x;
    this.y = y;
    this.update = function() {
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.beginPath();
        ctx.fillStyle = color;
        ctx.arc(0, 0, this.radius, 0, 2*Math.PI);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }
    this.newPos = function() {
        this.angle += this.moveAngle * Math.PI / 180;
    }
}
*/


function Bullet(radius, color, x, y) {

    this.reloadTime=0;
    this.radius = radius;
    this.speed = 15;
    this.angle = 0;
    this.x = x;
    this.y = y;
    this.update = function() {
        ctx = myGameArea.context;
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.beginPath();
        ctx.translate(0, -30);
        ctx.fillStyle = color;
        ctx.arc(0, 0, this.radius, 0, 2*Math.PI);
        ctx.closePath();
        ctx.fill();
        ctx.restore();
    }
    this.newPos = function() {
        this.x += this.speed * Math.sin(this.angle);
        this.y -= this.speed * Math.cos(this.angle);
    }
}

///////////////////////////////////// MAIN FUNCTION
function updateGameArea() {

    myGameArea.clear();

    ///////////////////////////////////////////////////////////////////////////// player tank

    tower.moveAngle = 0;
    tower.speed = 0;
    body.moveAngle = 0;
    body.speed = 0;



    // body rotation, turrent static
    if (myGameArea.keys && myGameArea.keys[37]){
      body.moveAngle = -1;
      tower.moveAngle = -1;
    }
    if (myGameArea.keys && myGameArea.keys[39]){
      body.moveAngle = 1;
      tower.moveAngle = 1;
    }
    if (myGameArea.keys && myGameArea.keys[38]){
      body.speed=1;
      tower.x=body.x;
      tower.y=body.y
    }
    if (myGameArea.keys && myGameArea.keys[40]){
      body.speed=-1;
      tower.x=body.x;
      tower.y=body.y;
    }

    // map control
    if(body.x>=800){
      body.x-=2;
    }
    if(body.x<=0){
      body.x+=2;
    }
    if(body.y>=600){
      body.y-=2;
    }
    if(body.y<=0){
      body.y+=2;
    }

    // touching dead tanks by player

    for(var i = 0; i < kills.length; i++) {
          if((Math.abs(kills[i].x-body.x)<30)&&(Math.abs(kills[i].y-body.y)<30)){
            body.x=previousX;
            body.y=previousY;
          }
    }


    // touching enemy tank
    if((Math.abs(aiBody.x-body.x)<30)&&(Math.abs(aiBody.y-body.y)<30)){
      body.x=previousX;
      body.y=previousY;
    }



    // turrent rotation
    if (myGameArea.keys && myGameArea.keys[65]){
      tower.moveAngle = -1;
    }
    if (myGameArea.keys && myGameArea.keys[68]){
      tower.moveAngle = 1;
    }

    // turrent + body rotation
    if (myGameArea.keys && myGameArea.keys[65] && myGameArea.keys[37]){
      tower.moveAngle = -2;
    }
    if (myGameArea.keys && myGameArea.keys[68] && myGameArea.keys[39]){
      tower.moveAngle = 2;
    }
    if (myGameArea.keys && myGameArea.keys[65] && myGameArea.keys[39]){
      tower.moveAngle = 0;
    }
    if (myGameArea.keys && myGameArea.keys[68] && myGameArea.keys[37]){
      tower.moveAngle = 0;
    }



    ///////////////////////////////////////////////////////////////////////////////////////////////// ai tank

    // movement

    // touching dead tanks by ai tank

     for(var i = 0; i < kills.length; i++) {
          if((Math.abs(kills[i].x-aiBody.x)<30)&&(Math.abs(kills[i].y-aiBody.y)<30)){
            aiBody.x=aiPreviousX;
            aiBody.y=aiPreviousY;
            aiX="none";
            aiY="none";
          }
      }

    // touching player tank
    if((Math.abs(body.x-aiBody.x)<30)&&(Math.abs(body.y-aiBody.y)<30)){
      aiBody.x=aiPreviousX;
      aiBody.y=aiPreviousY;
      aiX="none";
      aiY="none";
    }

    if(Math.abs(aiX-aiBody.x)<15&&Math.abs(aiY-aiBody.y)<15){
      aiX="none";
      aiY="none";
    }

    if(aiX=="none"&&aiY=="none"){
      aiX=Math.round(Math.random()*800);
      aiY=Math.round(Math.random()*600);
      aiDestinationAngle=Math.atan2(aiBody.y - aiY, aiBody.x - aiX)+(-90 * Math.PI / 180)+2*Math.PI;
      aiBody.speed=1;
    }

    if(Math.abs(aiBody.angle-aiDestinationAngle)<0.03){
      aiBody.speed=1;
      aiBody.angle=aiDestinationAngle;
      aiBody.moveAngle=0;
    }else if(Math.abs(aiBody.angle-aiDestinationAngle)>0.03){
      aiBody.speed=0;
      if(aiBody.angle<aiDestinationAngle){
        aiBody.moveAngle=1;
      }else if(aiBody.angle>aiDestinationAngle){
        aiBody.moveAngle=-1;
      }
    }

// destination target of ai tank to go to
/*
    ctx = myGameArea.context;
    ctx.save();
    ctx.translate(aiX, aiY);
    ctx.fillStyle ="red";
    ctx.fillRect(20 / -2, 20 / -2, 20, 20);
    ctx.restore();
*/
//console.log(Math.abs(aiDestinationAngle));




    //////////////////////////////////////////////////////////////// shooting and hits

    // moving the tower
    aiTargetAngle=Math.atan2(aiBody.y - body.y, aiBody.x - body.x)+(-90 * Math.PI / 180);


    if(Math.abs(aiTower.angle-aiTargetAngle)<0.03){
      aiTower.angle=aiTargetAngle;
      shotReady=true;
    }else if(Math.abs(aiTower.angle-aiTargetAngle)>0.03){
      shotReady=false;
      if(aiTower.angle<aiTargetAngle){
        aiTower.moveAngle=1;
      }else if(aiTower.angle>aiTargetAngle){
        aiTower.moveAngle=-1;
      }
    }


    // ai shooting
    if(aiReloadTime>0){
      aiReloadTime--;
    }

    if (aiReloadTime==0&&shotReady){
      //soundShotAi.play();
      aiBullet = new Bullet(2, "red", aiBody.x, aiBody.y);
      aiBullet.angle = aiTower.angle+( (Math.round(Math.random() * (30)) - 15) * Math.PI / 180);
      aiReloadTime=250;
    }

    // player shooting
    if (myGameArea.keys && myGameArea.keys[83] && reloadTime==0){
      //soundShot.play();
      bullet = new Bullet(2, "red", body.x, body.y);
      bullet.angle = tower.angle;
      //bullet.angle = tower.angle+( (Math.round(Math.random() * (30)) - 15) * Math.PI / 180);
      reloadTime=250;
    }
    if(reloadTime>0){
      reloadTime--;
    }

    // ai tank hit
   if(bullet!=null && Math.abs(bullet.x-aiBody.x)<15 && Math.abs(bullet.y-aiBody.y)<15) {
     //soundHitAi.play();
    aiBody.hp=aiBody.hp-1;
    if(aiBody.hp<=0){
       kills.push(new DeadBody(aiBody.x, aiBody.y, aiBody.angle, aiTower.angle));
       aiBody = new Body(10, 30, 50, "gray", 500, 300);
       aiTower = new Tower(10, 3, 40, "black", 500, 300);
     }
     aiMarks.push(new movingMark(bullet.x, bullet.y));
     aiReloadTime = 250;
     aiX="none";
     aiY="none";
     bullet=null;
   }

   // player tank hit
   if(aiBullet!=null && Math.abs(aiBullet.x-body.x)<15 && Math.abs(aiBullet.y-body.y)<15) {
     //soundHit.play();
     body.hp=body.hp-1;
     if(body.hp<=0){
       kills.push(new DeadBody(body.x, body.y, body.angle, tower.angle));
       body = new Body(30, 50, "green", 100, 300);
       tower = new Tower(3, 40, "black", 100, 300);
     }

     reloadTime = 0;
     aiBullet=null;
   }

   // dead tank hit by player
   for(var i = 0; i < kills.length; i++) {
     if(bullet!=null && Math.abs(kills[i].x-bullet.x)<15 && Math.abs(kills[i].y-bullet.y)<15) {
       //soundHit.play();
       marks.push(new Mark(bullet.x, bullet.y));
       bullet=null;
     }
   }

   // dead tank hit by ai tank

   for(var i = 0; i < kills.length; i++) {
     if(aiBullet!=null && Math.abs(kills[i].x-aiBullet.x)<15 && Math.abs(kills[i].y-aiBullet.y)<15) {
       //soundHit.play();
       marks.push(new Mark(aiBullet.x, aiBullet.y));
       aiBullet=null;
     }
   }



   ///////////////////////////////////////////////////////////////////////// drawing

   // previous positions of tanks
   previousX=body.x;
   previousY=body.y;
   aiPreviousX=aiBody.x;
   aiPreviousY=aiBody.y;

   // drawing kills
   for(var i = 0; i < kills.length; i++) {
     kills[i].update();
   }

   // drawing marks for dead tanks
   for(var i = 0; i < marks.length; i++) {
     marks[i].update();
   }

   // drawing ai
   aiTower.x=aiBody.x;
   aiTower.y=aiBody.y;


   aiBody.newPos();
   aiTower.newPos();
   if(aiBullet!=null){
     aiBullet.newPos();
   }


   aiBody.update();
   aiTower.update();

   if(aiBullet!=null){
     aiBullet.update();
   }

   // drawing marks after bullets for ai tank
   for(var i = 0; i < aiMarks.length; i++) {
     aiMarks[i].update();
   }

   // drawing player
   body.newPos();
   tower.newPos();
   if(bullet!=null){
     bullet.newPos();
   }
   body.update();
   tower.update();
   if(bullet!=null){
     bullet.update();
   }


}
</script>



</body>
</html>
